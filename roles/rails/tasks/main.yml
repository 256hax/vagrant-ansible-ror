---
#--- Setup ---#
- name: Install Yarn repo
  become: yes
  get_url:
    url: "{{ yarn_repo }}"
    dest: "{{ yarn_dest }}"
  # shell: "curl --silent --location https://dl.yarnpkg.com/rpm/yarn.repo | sudo tee /etc/yum.repos.d/yarn.repo"

- name: Install Yarn
  become: yes
  dnf:
    name:
      - yarn

- name: Install Node.js
  become: yes
  dnf:
    name:
      - nodejs

- name: Set bundle installation path
  shell: "bundle config set path 'vendor/bundle'"

#--- Rails with SQLite ---#
- name: Create sample Rails directory
  file:
    path: "{{ sample_rails_w_sqlite_path }}"
    state: directory

- name: Copy Gemfile
  copy:
    src: "../files/Gemfile"
    dest: "{{ sample_rails_w_sqlite_path }}"

- name: Install RubyGems
  bundler:
      state: present
  args:
    chdir: "{{ sample_rails_w_sqlite_path }}"

- name: Rails new
  expect:
    command: "bundle exec rails new ."
    responses:
      (.*)Overwrite (.*)Gemfile(.*): "Y"
    # timeout 1200 sec = 20 min
    timeout: 1200
  args:
    chdir: "{{ sample_rails_w_sqlite_path }}"

- name: Rails scaffold
  shell: "bundle exec rails g scaffold user name:string age:integer"
  args:
    chdir: "{{ sample_rails_w_sqlite_path }}"
  # ignore_errors: yes

- name: Rails DB migrate
  shell: "bundle exec rails db:migrate"
  args:
    chdir: "{{ sample_rails_w_sqlite_path }}"
  # ignore_errors: yes
